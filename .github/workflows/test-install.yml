name: Test Install Scripts

on:
  push:
    branches: ['**']
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-install.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  test-install:
    name: Test Install (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: macos-latest
            name: macos
          - os: windows-latest
            name: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Unix (Linux/macOS)
      - name: Run install script (Unix)
        if: runner.os != 'Windows'
        run: sh install.sh

      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          # Check binary exists and is executable
          test -x "$HOME/.local/bin/memo" || exit 1
          # Check it runs
          "$HOME/.local/bin/memo" --version

      # Windows
      - name: Run install script (Windows)
        if: runner.os == 'Windows'
        run: powershell -File install.ps1

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Check binary exists
          $exe = "$env:USERPROFILE\.local\bin\memo.exe"
          if (-not (Test-Path $exe)) { exit 1 }
          # Check it runs
          & $exe --version
